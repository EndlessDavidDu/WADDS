---
title: "Lab 6"
author: "WADDS"
date: "February 21, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
COflights<-read_csv("https://files.osf.io/v1/resources/3z5as4pej8/providers/osfstorage/5a8ca28f57103100104584db")
```

## Overall Question

In our report we aim to answer the question: what are the primary factors that contribute to flight delays and delayed arrivals to and from Denver.

This is an important question for our team to answer for the airport because it will allow them to focus their efforts on preventing or minimizing the factors that cause delays in order to decrease the amount of delays or allow them to better estimate arrival times. This will make those who use the airport more satisfied overall and keep operations running according to schedule within the airport.

## Findings

## Recommendations

## Individual Findings

### Abby
We wish to see what factors can influence delayed arrivals and departures to and from Denver. We wish to first analyze if the length of the flight impacts the arrivals and departures. This can allow us to make recommendations to the airport about scheduling arrival and departure times. I hope to see if flights greater than two hours have a higher probability of having a delayed arrival (greater than or equal to 15 minutes) than shorter flights.

```{r Abby1, echo=FALSE}
arriving_long<-as.tibble(filter(COflights,DEST=="DEN", !is.na(ARR_TIME), AIR_TIME>=120))
late_arriving_long<-as.tibble(filter(COflights, DEST=="DEN", !is.na(ARR_TIME), AIR_TIME>=120, ARR_DELAY>=15))

departing_long<-as.tibble(filter(COflights,ORIGIN=="DEN", !is.na(ARR_TIME), AIR_TIME>=120))
late_departing_long<-as.tibble(filter(COflights, ORIGIN=="DEN", !is.na(ARR_TIME), AIR_TIME>=120, DEP_DELAY>=15))

arriving_short<-as.tibble(filter(COflights,DEST=="DEN", !is.na(ARR_TIME), AIR_TIME<120))
late_arriving_short<-as.tibble(filter(COflights, DEST=="DEN", !is.na(ARR_TIME), AIR_TIME<120, ARR_DELAY>=15))

departing_short<-as.tibble(filter(COflights,ORIGIN=="DEN", !is.na(ARR_TIME), AIR_TIME<120))
late_departing_short<-as.tibble(filter(COflights, ORIGIN=="DEN", !is.na(ARR_TIME), AIR_TIME<120, DEP_DELAY>=15))

prob_late_arriving_long<-nrow(late_arriving_long)/nrow(arriving_long)
prob_late_departing_long<-nrow(late_departing_long)/nrow(departing_long)
prob_late_arriving_short<-nrow(late_arriving_short)/nrow(arriving_short)
prob_late_departing_short<-nrow(late_departing_short)/nrow(departing_short)

df<-data.frame(x=c("Long Arriving","Long Departing","Short Arriving","Short Departing"),y=c(0.1754298,0.2136266,0.1447172,0.1662359))
ggplot(data=df,aes(x,y))+geom_col()
```

As we can see from the plot above, there is a greater probability a flight will be late when the flight is over two hours long. This is true for boh late departures and late arrivals. A short flight arriving in Denver is the least likely to arrive late, while a long flight departing from Denver is the most likely to arrive late to its destination. 

I also want to analyze whether the probability of a late arrival or departure changes based on the airline. To do this I will analyze the most common airlines used domestically in the United States. The 4 biggest domestic airlines are: American Airlines, United Airlines, Southwest, and Delta. This list was taken from a Business Insider Article.

```{r Abby2}
totalflightsarriving<-as.tibble(filter(COflights, !is.na(ARR_TIME),DEST=="DEN"))

American_Late_Arrive<-as.tibble(filter(COflights, !is.na(ARR_TIME),DEST=="DEN",ARR_DELAY>=15,CARRIER=="AA"))

United_Late_Arrive<-as.tibble(filter(COflights,!is.na(ARR_TIME),DEST=="DEN",ARR_DELAY>=15,CARRIER=="UA"))

Southwest_Late_Arrive<-as.tibble(filter(COflights,!is.na(ARR_TIME),DEST=="DEN",ARR_DELAY>=15, CARRIER=="WN"))

Delta_Late_Arrive<-as.tibble(filter(COflights,!is.na(ARR_TIME),DEST=="DEN",ARR_DELAY>=15,CARRIER=="DL"))

Prob_American<-nrow(American_Late_Arrive)/nrow(totalflightsarriving)
Prob_United<-nrow(United_Late_Arrive)/nrow(totalflightsarriving)
Prob_Southwest<-nrow(Southwest_Late_Arrive)/nrow(totalflightsarriving)
Prob_Delta<-nrow(Delta_Late_Arrive)/nrow(totalflightsarriving)

df2<-data.frame(x=c("American","United","Southwest","Delta"),y=c(Prob_American,Prob_United,Prob_Southwest,Prob_Delta))
ggplot(data=df2,aes(x,y))+geom_col()
```

As we can see from the plot above, of the flights arriving to Denver, there is a slight difference between the probability a flight will arrive late based on the airline. A flight is more likely to arrive to Denver late if the airline is Southwest or United, and is less likely to arrive to Denver late of the airline is American or Delta. Southwest has a higher probability of arriving late to Denver than United, and Delta is less likely to arrive to Denver late than American.

```{r Abby 3}
totalflightsdeparting<-as.tibble(filter(COflights, !is.na(ARR_TIME),ORIGIN=="DEN"))

American_Late_Depart<-as.tibble(filter(COflights, !is.na(ARR_TIME),ORIGIN=="DEN",DEP_DELAY>=15,CARRIER=="AA"))

United_Late_Depart<-as.tibble(filter(COflights,!is.na(ARR_TIME),ORIGIN=="DEN",DEP_DELAY>=15,CARRIER=="UA"))

Southwest_Late_Depart<-as.tibble(filter(COflights,!is.na(ARR_TIME),ORIGIN=="DEN",DEP_DELAY>=15, CARRIER=="WN"))

Delta_Late_Depart<-as.tibble(filter(COflights,!is.na(ARR_TIME),ORIGIN=="DEN",DEP_DELAY>=15,CARRIER=="DL"))

Prob_American_d<-nrow(American_Late_Depart)/nrow(totalflightsdeparting)
Prob_United_d<-nrow(United_Late_Depart)/nrow(totalflightsdeparting)
Prob_Southwest_d<-nrow(Southwest_Late_Depart)/nrow(totalflightsdeparting)
Prob_Delta_d<-nrow(Delta_Late_Depart)/nrow(totalflightsdeparting)

df3<-data.frame(x=c("American","United","Southwest","Delta"),y=c(Prob_American_d,Prob_United_d,Prob_Southwest_d,Prob_Delta_d))
ggplot(data=df3,aes(x,y))+geom_col()
```
As we can see from the plot above, the probability of a flight departing Denver late is higher for Southwest and United airlines. While it is less likely for American and Delta airline flights to depart late from Denver. This plot corresponds to the plot above, which indicates that a late arrival time corresponds to a late departure time once the plane has reached their first destination. Because Southwest and United are such large airlines, it makes sense that they would have a higher probability of running late, since there are so many flights to attempt to keep on time. 

### Sarah

In order to analyze what factors might contribute to flight delays, I will analyze patterns in arrival delays between months, and also take into account what proportion of these delays are due to weather related issues. This will help us understand if different months have significantly different proportions of delays, and if these delays are solely due to weather, or if they might be due to other factors. 

``` {r sarah1, echo=FALSE}

prop<-data.frame(month=numeric(), total=numeric(),delayed=numeric(),proportion=numeric(),weatherdelayed=numeric(),propweather=numeric(),propweathergivendelay=numeric())

i=1
while (i<13){
  prop[i,1]<-i
  prop[i,2]<-dim(filter(COflights,MONTH==i))[1]
  prop[i,3]<-dim(filter(COflights,MONTH==i & ARR_DELAY>15))[1]
  prop[i,4]<-prop[i,3]/prop[i,2]
  prop[i,5]<-dim(filter(COflights,MONTH==i & WEATHER_DELAY>15))[1]
  prop[i,6]<-prop[i,5]/prop[i,2]
  prop[i,7]<-prop[i,5]/prop[i,3]
  i=i+1
}
#factor(prop$month)
ggplot(data=prop)+geom_point(aes(x=month,y=proportion,shape='Probability of Delays per Month'),color="blue")+geom_point(aes(x=month,y=propweather,shape='Probability of Weather Delays per Month'),color="green")+geom_point(aes(x=month,y=propweathergivendelay,shape='Probability of Weather Delays Given Delays per Month'),color="red")



# 

#COflights1<-filter(COflights,ARR_DELAY != is.na(ARR_DELAY))
#COflights1$MONTH<-factor(COflights1$MONTH)
#COflightsdelay<-filter(COflights1,ARR_DELAY>15)
#ggplot(data=COflights1)+geom_violin(aes(x=MONTH,y=ARR_DELAY))
#ggplot(data=COflightsdelay)+geom_boxplot(aes(x=MONTH,y=ARR_DELAY))
#ggplot(data=COflights1)+geom_jitter(aes(x=AIR_TIME,y=ARR_DELAY),alpha=0.1)
Newproportions<-data.frame(prop[,1],prop[,4],prop[,6],prop[,7])
colnames(Newproportions)<-c("Month","Arrivals Delayed", "Weather Delays", "Weather Delays Given Delayed")
kable(Newproportions)

```

The blue circles represent the probability a flight will be delayed in a given month. The green squares represent the probabiltiy that a flight will have a weather related delay in a given month. And the Red triangles represent the probability of a flight having a weather related delay given that it is delayed for a given month. 

The plot indicates a definite trend in delays across the different months of the year. Contrary to what one might expect, the months with the lowest proportion of weather related delays are September, October, and November, while July, August, and January seem to have the highest number of weather related delays, followed closely by December. Trends in overall delays follow a similar pattern, although January has a significantly higher proportion of delays than the rest, and November has a signifcantly lower proportion. 

Although initially the results may seem strange, it is possible that the summer months have significant weather delays is due to rain and thunderstorms, and the worst month for snow in Colorado is January. The proportions of delays overall seem to match the tendencies of weather related delays per month; however, still only a small fraction (less than 5 percent) of overall delays are weather related, so there must be other significant factors involved, which my teammates have investigated.


## Summary of Individual Contributions

Abby: I plotted the probability of flights arriving and leaving Denver late based on flight lengths. I found that longer flights are more likely to arrive and depart Denver late than flights under two hours. I then plotted the probabilities of late departures and arrivals based on airline carriers. I found that Southwest and United were more likely to be late than American and Delta airlines. These are the four largest domestic airlines, and knowing which flights run late can help the airports determine scheduling issues based on flight length and airline. 

Sarah: I used the filter function in a while loop in order find conditional probabilities of delays per month and weather delays per month. I plotted these with geom_point and showed different probabilities using different shaped and colored points. I did this in order to analyze weather there were patterns in delays between months and if these differences were solely weather related, or if there might be other reasons certain months might yield more delays than others. 
