---
title: "Will_Lab 13"
output: html_document
---

```{r setup, include=FALSE}
library(gapminder) # data from gapminder.org
library(tidyverse)
# library(googlesheets) # used to read data from google sheets
library(readxl) # used to read data from .xlsx files
# library(dplyr) # used to perform data transformation and manipulation
library(ggplot2) # used for data visualization
```

## First Step
with the economy develop, it is plausible that the consumption of sugar per person has a significant increase. we will explore whether the consumption of sugar had a significant jump from 70s to 80s. And we will find data-based evidence. 


## Null Hypothesis.
Assume that the averges of consumption of sugar per person over 70s and 80s are equal. Here we take the average consumption over the countries as a proxy of the overall level of the consumption.

Our test statistic, or "summary" of the data is the average consumption of sugar per person 80s subtracted by the one over 70s.


```{r, echo = TRUE}
# Reading data from .xlsx file
# sugarConsumption <- gs_url("https://docs.google.com/spreadsheets/d/1IbDM8z5XicMIXgr93FPwjgwoTTKMuyLfzU6cQrGZzH8/pub?gid=0",lookup = FALSE)%>%gs_read(ws = "indicator sugar_consumption", check.names=FALSE)

sugarConsumption_unfilter <- as.tibble(read_excel("indicator sugar_consumption.xlsx"))
sugarConsumption <- sugarConsumption_unfilter[!is.na(sugarConsumption_unfilter[,2]),]


# the average consumption of sugar in 70s
sugarConsumption70 <- colMeans(sugarConsumption[,11:20])-> unlist 
avg_Consumption70 <- mean(sugarConsumption70)

# the average consumption of sugar in 60s
sugarConsumption80 <- colMeans(sugarConsumption[,21:30])-> unlist 
avg_Consumption80 <- mean(sugarConsumption80)
# the real data summary statistic
obsDiff <- avg_Consumption80 - avg_Consumption70
```

## Mix Up
Now assume that the year labels don't matter. We mix up the labels, to calculate the test statistic for the mixed-up labels.

```{r, echo = TRUE}
N = 6
diffAverage <- replicate(999, {
    all <- sample(c(sugarConsumption70,sugarConsumption80))
    testGroup1 <- all[1:N]
    testGroup2 <- all[(N+1):(2*N)]
  return(mean(testGroup2) - mean(testGroup1))
})
hist(diffAverage)
abline(v=obsDiff, col="red", lwd=2)
```

## The Percentile
Now we compare the real data summary statistic with the distribution generated above. 
```{r, echo = FALSE}
# minDiff <- min(diffAverage)
# maxDiff <- max(diffAverage)
# prob <- (obsDiff - minDiff) / (maxDiff - minDiff)
```
```{r, echo = TRUE}
# Find the percentile
percentile <- ecdf(diffAverage)
percentile(obsDiff)
```

We find that the real data summary is in the right hand of  99.5% of the distribution.


## Conclusion
The real data summary statistic is significantly different from the data generated by mixing up the year labels.

So we reject the null hypothesis. That is to say, the consumption of sugar per person had a significant difference between 1970s and 1980s,
